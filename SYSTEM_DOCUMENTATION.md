# 小区房屋租赁管理平台 - 系统文档

## 目录
1. [系统概述](#1-系统概述)
2. [技术架构](#2-技术架构)
3. [系统角色与权限](#3-系统角色与权限)
4. [功能模块详解](#4-功能模块详解)
5. [角色用例](#5-角色用例)

---

## 1. 系统概述

### 1.1 项目简介
本系统是一个**基于微信小程序的小区房屋租赁管理平台**，采用前后端分离架构，支持微信小程序和Web管理后台。

### 1.2 核心特色
- **小区认证机制**：双级审核（小区管理员+平台管理员）
- **电子合同系统**：PDF生成、电子签名、SHA256防篡改
- **AI内容审核**：阿里云百炼qwen-plus大模型
- **实时通讯**：WebSocket即时聊天
- **信用评价体系**：双向评价，信用分计算
- **敏感词过滤**：DFA算法高性能过滤

---

## 2. 技术架构

### 2.1 后端技术栈
| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 3.5.8 | 后端框架 |
| MyBatis-Plus | 3.5.8 | ORM框架 |
| Sa-Token | 1.44.0 | 权限认证 |
| MySQL | - | 数据库 |
| Redis | - | 缓存/Session |
| MinIO | 8.5.12 | 对象存储 |
| WebSocket | - | 实时通讯 |
| Spring AI Alibaba | 1.0.0-M5.1 | AI集成 |
| iTextPDF | 5.5.13.3 | PDF生成 |
| sensitive-word | 0.20.0 | 敏感词(DFA) |

### 2.2 前端技术栈
- **UniApp** - 跨平台小程序框架
- **Vue.js** - 前端框架
- **Element Plus** - 管理后台UI

### 2.3 系统架构图
```
┌─────────────────────────────────────────────────────┐
│                    客户端层                          │
│  微信小程序(UniApp)  │  Web管理后台  │  H5页面       │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP/WebSocket
┌──────────────────────▼──────────────────────────────┐
│              Spring Boot 应用 (:8888)               │
│  Controller → Service → Mapper → MySQL             │
└──────────────────────┬──────────────────────────────┘
                       │
┌──────────┬───────────┼───────────┬──────────────────┐
│  MySQL   │   Redis   │   MinIO   │  阿里云百炼       │
└──────────┴───────────┴───────────┴──────────────────┘
```

---

## 3. 系统角色与权限

### 3.1 角色定义
| 角色 | userType | 描述 |
|------|----------|------|
| 游客 | - | 未登录，可浏览房源 |
| 租客 | 3 | 普通用户，可租房 |
| 房东 | 4 | 已认证业主，可发布房源 |
| 小区管理员 | 0 | 管理特定小区 |
| 平台管理员 | 0 | 最高权限 |

### 3.2 权限矩阵
| 功能 | 游客 | 租客 | 房东 | 小区管理员 | 平台管理员 |
|------|------|------|------|------------|------------|
| 浏览房源 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 收藏房源 | ✗ | ✓ | ✓ | ✓ | ✓ |
| 预约看房 | ✗ | ✓ | ✗ | ✗ | ✗ |
| 发布房源 | ✗ | ✗ | ✓ | ✗ | ✗ |
| 签署合同 | ✗ | ✓ | ✓ | ✗ | ✗ |
| 审核房源 | ✗ | ✗ | ✗ | ✓ | ✓ |
| 审核合同 | ✗ | ✗ | ✗ | ✓ | ✓ |
| 管理用户 | ✗ | ✗ | ✗ | ✗ | ✓ |
| 管理小区 | ✗ | ✗ | ✗ | ✗ | ✓ |

---

## 4. 功能模块详解

### 4.1 用户认证模块 (AuthService)
- **微信登录**: 调用微信API获取openid，自动注册
- **管理员登录**: 手机号+BCrypt密码验证
- **Token管理**: Sa-Token，UUID样式，24小时有效期

### 4.2 房源管理模块 (HouseService)
- **发布房源**: 需小区认证，状态pending
- **搜索房源**: 多条件筛选（价格、面积、户型、地区）
- **房源审核**: 管理员审核，通过后上架
- **收藏/举报**: 用户收藏和举报功能

### 4.3 预约看房模块 (AppointmentService)
- **状态流转**: pending → confirmed → completed
- **双向操作**: 房东可确认/拒绝，双方可取消

### 4.4 电子合同模块 (ContractService)
- **创建合同**: 房东发起，自定义条款
- **电子签名**: 手写签名，保存时间戳
- **PDF生成**: iTextPDF + 中文字体
- **防篡改**: SHA256哈希值验证
- **解约流程**: 申请→审核→终止

### 4.5 实时聊天模块 (ChatService)
- **WebSocket**: `/websocket/chat/{userId}`
- **消息类型**: 文本、图片
- **心跳机制**: 30秒心跳，10分钟超时清理
- **敏感词过滤**: 实时过滤+AI审核

### 4.6 小区认证模块 (CommunityVerificationService)
- **双级审核**: 小区管理员→平台管理员
- **证明材料**: 房产证、租赁合同、物业证明

### 4.7 租赁交易模块 (RentalTransactionService)
- **状态流转**: pending_sign → living → completed → evaluated
- **入住确认**: 双方确认后自动生成账单
- **退租确认**: 双方确认后可评价

### 4.8 信用评价模块 (CreditEvaluationService)
- **双向评价**: 房东评租客，租客评房东
- **评分范围**: 1-5星
- **信用分计算**: 平均分×权重系数(评价数/10)

### 4.9 AI内容审核模块 (AiContentModerationService)
- **模型**: 阿里云百炼qwen-plus
- **违规类型**: spam/harassment/fraud/illegal等
- **自动处理**: critical封禁7天，high禁言3天
- **定时任务**: 每小时审核最近消息

### 4.10 敏感词过滤模块 (SensitiveWordService)
- **算法**: DFA确定有限自动机
- **特性**: 忽略大小写/全角半角/重复字符
- **词库**: 系统默认+数据库自定义+白名单

### 4.11 系统通知模块 (SystemNotificationService)
- **通知类型**: 合同/房源/认证/举报/交易
- **推送方式**: WebSocket实时推送
- **管理功能**: 标记已读、批量发送

### 4.12 文件上传模块 (MinioService)
- **存储**: MinIO分布式对象存储
- **Bucket**: houserent(房源)、avatars(头像)
- **限制**: 单文件10MB

### 4.13 定时任务模块 (ScheduledTasks)
- WebSocket会话清理（每5分钟）
- 合同到期提醒（每天9:00）
- 过期通知清理（每天2:00）
- AI定时审核（每小时）

---

## 5. 角色用例

### 5.1 租客用例
```
租客 ─┬─ 浏览房源
      ├─ 收藏房源
      ├─ 预约看房
      ├─ 联系房东(聊天)
      ├─ 签署合同
      ├─ 确认入住
      ├─ 支付租金
      ├─ 评价房东
      ├─ 提交小区认证
      ├─ 发布论坛帖子
      └─ 举报房源
```

### 5.2 房东用例
```
房东 ─┬─ 发布房源
      ├─ 管理房源(上架/下架)
      ├─ 处理预约(确认/拒绝)
      ├─ 创建合同
      ├─ 签署合同
      ├─ 确认入住
      ├─ 收取租金
      ├─ 管理租客
      ├─ 评价租客
      ├─ 查看收入统计
      └─ 申请解约
```

### 5.3 小区管理员用例
```
小区管理员 ─┬─ 审核房源
            ├─ 审核小区认证(一级)
            ├─ 审核合同
            ├─ 审核解约申请
            ├─ 处理举报
            ├─ 管理配套设施
            ├─ 处理配套反馈
            ├─ 发送通知
            ├─ 管理论坛(删帖)
            └─ 查看小区统计
```

### 5.4 平台管理员用例
```
平台管理员 ─┬─ 管理用户(封禁/解封)
            ├─ 管理小区(增删改查)
            ├─ 管理小区管理员
            ├─ 审核认证(二级/最终)
            ├─ 审核房源
            ├─ 审核合同
            ├─ 处理举报
            ├─ 管理敏感词
            ├─ 批量发送通知
            └─ 查看全局统计
```
