# 小区房屋租赁管理平台 - 流程图与时序图

## 1. 业务流程图

### 1.1 用户注册登录流程
```
开始 → 打开小程序 → 微信授权登录 → 获取code
                                    ↓
              后端调用微信API换取openid
                                    ↓
                    ┌───────────────┴───────────────┐
                    ↓                               ↓
               用户存在                          新用户
                    ↓                               ↓
               检查状态                        自动注册(租客)
                    ↓                               ↓
    ┌───────────────┼───────────────┐               │
    ↓               ↓               ↓               │
  active         banned          muted              │
    ↓               ↓               ↓               │
 生成Token      拒绝登录        限制功能            │
    ↓                               │               │
    └───────────────────────────────┴───────────────┘
                                    ↓
                              登录成功 → 结束
```

### 1.2 发布房源流程
```
开始 → 点击发布房源 → 检查小区认证状态
                              ↓
              ┌───────────────┴───────────────┐
              ↓                               ↓
           未认证                           已认证
              ↓                               ↓
         跳转认证页面                    填写房源信息
              ↓                               ↓
           [结束]                        上传房源图片
                                              ↓
                                         提交审核
                                              ↓
                                      状态: pending
                                              ↓
                                    等待管理员审核
                                              ↓
                          ┌───────────────────┴───────────────┐
                          ↓                                   ↓
                       审核通过                            审核拒绝
                          ↓                                   ↓
                   状态: approved                      状态: rejected
                          ↓                                   ↓
                      自动上架                           通知拒绝原因
                          ↓                                   ↓
                   状态: online                          可修改重审
                          ↓                                   ↓
                       [结束]                              [结束]
```

### 1.3 签署合同流程
```
开始 → 房东创建合同草稿 → 选择房源和租客 → 填写合同条款
                                                  ↓
                                           合同状态: draft
                                                  ↓
                    ┌─────────────────────────────┴──────────────────────────┐
                    ↓                                                        ↓
               房东签名                                                 通知租客
                    ↓                                                        ↓
              保存签名数据                                              租客查看
                    ↓                                                        ↓
                    └────────────────────────┬───────────────────────────────┘
                                             ↓
                                        租客签名
                                             ↓
                                       保存签名数据
                                             ↓
                               (双方签署完成) 状态: signed
                                             ↓
                                     提交管理员审核
                                             ↓
                          ┌──────────────────┴──────────────────┐
                          ↓                                      ↓
                       审核通过                              审核拒绝
                          ↓                                      ↓
                  状态: effective                         状态: rejected
                          ↓                                      ↓
                ┌─────────┴─────────┐                     通知拒绝原因
                ↓                   ↓                            ↓
           创建交易记录       生成PDF合同                    回到draft
                ↓                   ↓                            ↓
           生成租金账单       计算SHA256哈希                  可修改重审
                ↓                   ↓                            ↓
                └─────────┬─────────┘                         [结束]
                          ↓
                       [结束]
```

### 1.4 预约看房流程
```
开始 → 租客浏览房源 → 点击预约看房 → 选择看房时间 → 填写联系方式
                                                            ↓
                                                      创建预约记录
                                                     状态: pending
                                                            ↓
                                                       通知房东
                                                            ↓
                              ┌──────────────────────────────┼──────────────────────────────┐
                              ↓                              ↓                              ↓
                          房东确认                       房东拒绝                        超时未处理
                              ↓                              ↓                              ↓
                      状态: confirmed                状态: rejected                 状态: cancelled
                              ↓                              ↓                              ↓
                         通知租客                      通知租客原因                     通知双方
                              ↓                              ↓                              ↓
                    ┌─────────┴─────────┐                 [结束]                        [结束]
                    ↓                   ↓
                按时看房             取消预约
                    ↓                   ↓
            状态: completed      状态: cancelled
                    ↓                   ↓
                 [结束]              [结束]
```

### 1.5 小区认证流程
```
开始 → 用户申请认证 → 选择小区 → 选择证明类型 → 上传证明材料
                                                      ↓
                                                 提交认证申请
                                                状态: pending
                                                      ↓
                                              小区管理员审核(一级)
                                                      ↓
                          ┌───────────────────────────┴───────────────────────────┐
                          ↓                                                       ↓
                   小区管理员通过                                          小区管理员拒绝
           community_admin_status: approved                       community_admin_status: rejected
                          ↓                                                       ↓
                  平台管理员审核(二级)                                       认证失败
                          ↓                                                  通知用户
              ┌───────────┴───────────┐                                          ↓
              ↓                       ↓                                       [结束]
         平台通过                 平台拒绝
  platform_admin_status:    platform_admin_status:
       approved                 rejected
              ↓                       ↓
         认证成功                 认证失败
       更新用户角色              通知用户
              ↓                       ↓
          [结束]                   [结束]
```

### 1.6 租赁交易流程
```
开始 → 合同生效 → 创建交易记录 → 状态: pending_checkin
                                        ↓
                            等待双方确认入住
                                        ↓
                ┌───────────────────────┴───────────────────────┐
                ↓                                               ↓
           房东确认入住                                    租客确认入住
                ↓                                               ↓
                └─────────────────┬─────────────────────────────┘
                                  ↓
                          (双方都确认后)
                           状态: living
                                  ↓
                           自动生成租金账单
                                  ↓
                ┌─────────────────┴─────────────────┐
                ↓                                   ↓
           正常续租                            申请退租
                ↓                                   ↓
           按月支付租金                    状态: pending_complete
                ↓                                   ↓
           [循环]                          等待双方确认退租
                                                    ↓
                              ┌─────────────────────┴─────────────────────┐
                              ↓                                           ↓
                         房东确认退租                                租客确认退租
                              ↓                                           ↓
                              └─────────────┬─────────────────────────────┘
                                            ↓
                                    (双方都确认后)
                                    状态: completed
                                            ↓
                                      可进行评价
                                            ↓
                                    状态: evaluated
                                            ↓
                                         [结束]
```

### 1.7 举报处理流程
```
开始 → 用户提交举报 → 选择举报类型 → 填写举报详情 → 上传证据图片
                                                          ↓
                                                    创建举报记录
                                                   状态: pending
                                                          ↓
                                                  管理员查看举报
                                                          ↓
                          ┌───────────────────────────────┼───────────────────────────────┐
                          ↓                               ↓                               ↓
                    举报属实(valid)              警告处理(warning)               举报不实(invalid)
                          ↓                               ↓                               ↓
                   状态: handled                   状态: handled                  状态: rejected
                          ↓                               ↓                               ↓
                    下架房源                         警告房东                      通知举报人
                    处罚房东                      不下架房源                           ↓
                          ↓                               ↓                          [结束]
                   通知举报人                      通知举报人
                          ↓                               ↓
                       [结束]                          [结束]
```

---

## 2. 时序图

### 2.1 微信登录时序图
```
┌──────┐          ┌──────────┐          ┌──────────┐          ┌─────────┐          ┌───────┐
│ 用户 │          │ 微信小程序│          │  后端API │          │微信服务器│          │ Redis │
└──┬───┘          └────┬─────┘          └────┬─────┘          └────┬────┘          └───┬───┘
   │                   │                     │                     │                   │
   │ 1.点击登录         │                     │                     │                   │
   │──────────────────▶│                     │                     │                   │
   │                   │                     │                     │                   │
   │                   │ 2.wx.login()        │                     │                   │
   │                   │────────────────────────────────────────▶  │                   │
   │                   │                     │                     │                   │
   │                   │ 3.返回code           │                     │                   │
   │                   │◀────────────────────────────────────────  │                   │
   │                   │                     │                     │                   │
   │                   │ 4.POST /auth/wechat/login {code}          │                   │
   │                   │────────────────────▶│                     │                   │
   │                   │                     │                     │                   │
   │                   │                     │ 5.jscode2session    │                   │
   │                   │                     │────────────────────▶│                   │
   │                   │                     │                     │                   │
   │                   │                     │ 6.返回openid        │                   │
   │                   │                     │◀────────────────────│                   │
   │                   │                     │                     │                   │
   │                   │                     │ 7.查询/创建用户      │                   │
   │                   │                     │─────────────────────────────────────────│
   │                   │                     │                     │                   │
   │                   │                     │ 8.生成Token，存储     │                   │
   │                   │                     │────────────────────────────────────────▶│
   │                   │                     │                     │                   │
   │                   │ 9.返回Token和用户信息 │                     │                   │
   │                   │◀────────────────────│                     │                   │
   │                   │                     │                     │                   │
   │ 10.登录成功        │                     │                     │                   │
   │◀──────────────────│                     │                     │                   │
```

### 2.2 发布房源时序图
```
┌──────┐       ┌──────────┐       ┌──────────┐       ┌───────┐       ┌───────┐
│ 房东 │       │ 微信小程序│       │  后端API │       │ MySQL │       │ MinIO │
└──┬───┘       └────┬─────┘       └────┬─────┘       └───┬───┘       └───┬───┘
   │                │                  │                 │               │
   │ 1.填写房源信息   │                  │                 │               │
   │───────────────▶│                  │                 │               │
   │                │                  │                 │               │
   │ 2.选择上传图片   │                  │                 │               │
   │───────────────▶│                  │                 │               │
   │                │                  │                 │               │
   │                │ 3.POST /file/upload                │               │
   │                │─────────────────▶│                 │               │
   │                │                  │                 │               │
   │                │                  │ 4.上传到MinIO    │               │
   │                │                  │────────────────────────────────▶│
   │                │                  │                 │               │
   │                │                  │ 5.返回图片URL    │               │
   │                │                  │◀────────────────────────────────│
   │                │                  │                 │               │
   │                │ 6.返回图片URL     │                 │               │
   │                │◀─────────────────│                 │               │
   │                │                  │                 │               │
   │ 7.点击发布      │                  │                 │               │
   │───────────────▶│                  │                 │               │
   │                │                  │                 │               │
   │                │ 8.POST /house/publish              │               │
   │                │─────────────────▶│                 │               │
   │                │                  │                 │               │
   │                │                  │ 9.检查小区认证   │               │
   │                │                  │────────────────▶│               │
   │                │                  │                 │               │
   │                │                  │ 10.保存房源(pending)             │
   │                │                  │────────────────▶│               │
   │                │                  │                 │               │
   │                │ 11.返回发布成功   │                 │               │
   │                │◀─────────────────│                 │               │
   │                │                  │                 │               │
   │ 12.显示待审核   │                  │                 │               │
   │◀───────────────│                  │                 │               │
```

### 2.3 签署合同时序图
```
┌──────┐   ┌──────┐   ┌──────────┐   ┌──────────┐   ┌───────┐   ┌───────┐
│ 房东 │   │ 租客 │   │ 微信小程序│   │  后端API │   │ MySQL │   │ MinIO │
└──┬───┘   └──┬───┘   └────┬─────┘   └────┬─────┘   └───┬───┘   └───┬───┘
   │          │            │              │             │           │
   │ 1.创建合同│            │              │             │           │
   │─────────────────────▶│              │             │           │
   │          │            │              │             │           │
   │          │            │ 2.POST /contract/create    │           │
   │          │            │─────────────▶│             │           │
   │          │            │              │             │           │
   │          │            │              │ 3.保存草稿   │           │
   │          │            │              │────────────▶│           │
   │          │            │              │             │           │
   │ 4.手写签名│            │              │             │           │
   │─────────────────────▶│              │             │           │
   │          │            │              │             │           │
   │          │            │ 5.POST /contract/{id}/landlord-sign    │
   │          │            │─────────────▶│             │           │
   │          │            │              │             │           │
   │          │            │              │ 6.保存签名   │           │
   │          │            │              │────────────▶│           │
   │          │            │              │             │           │
   │          │            │              │ 7.通知租客   │           │
   │          │            │              │─────────────────────────│
   │          │            │              │             │           │
   │          │ 8.收到通知  │              │             │           │
   │          │◀───────────│              │             │           │
   │          │            │              │             │           │
   │          │ 9.查看合同  │              │             │           │
   │          │───────────▶│              │             │           │
   │          │            │              │             │           │
   │          │ 10.手写签名│              │             │           │
   │          │───────────▶│              │             │           │
   │          │            │              │             │           │
   │          │            │ 11.POST /contract/{id}/tenant-sign     │
   │          │            │─────────────▶│             │           │
   │          │            │              │             │           │
   │          │            │              │ 12.更新状态signed        │
   │          │            │              │────────────▶│           │
   │          │            │              │             │           │
   │          │            │              │ 13.生成PDF   │           │
   │          │            │              │────────────────────────▶│
   │          │            │              │             │           │
   │          │            │              │ 14.计算SHA256│           │
   │          │            │              │────────────▶│           │
```

### 2.4 实时聊天时序图
```
┌──────┐   ┌──────┐   ┌──────────┐   ┌──────────┐   ┌───────┐   ┌────────┐
│用户A │   │用户B │   │ WebSocket│   │  后端API │   │ MySQL │   │AI审核  │
└──┬───┘   └──┬───┘   └────┬─────┘   └────┬─────┘   └───┬───┘   └───┬────┘
   │          │            │              │             │           │
   │ 1.建立WS连接           │              │             │           │
   │─────────────────────▶│              │             │           │
   │          │            │              │             │           │
   │          │            │ 2.注册用户会话│             │           │
   │          │            │─────────────▶│             │           │
   │          │            │              │             │           │
   │          │ 3.建立WS连接│              │             │           │
   │          │───────────▶│              │             │           │
   │          │            │              │             │           │
   │ 4.发送消息│            │              │             │           │
   │─────────────────────▶│              │             │           │
   │          │            │              │             │           │
   │          │            │ 5.敏感词过滤  │             │           │
   │          │            │─────────────▶│             │           │
   │          │            │              │             │           │
   │          │            │ 6.保存消息    │             │           │
   │          │            │──────────────────────────▶│           │
   │          │            │              │             │           │
   │          │            │ 7.异步AI审核  │             │           │
   │          │            │─────────────────────────────────────▶ │
   │          │            │              │             │           │
   │          │ 8.推送消息  │              │             │           │
   │          │◀───────────│              │             │           │
   │          │            │              │             │           │
   │ 9.心跳PING│            │              │             │           │
   │─────────────────────▶│              │             │           │
   │          │            │              │             │           │
   │ 10.心跳PONG           │              │             │           │
   │◀─────────────────────│              │             │           │
```

### 2.5 房源审核时序图
```
┌────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐    ┌────────┐
│ 管理员 │    │ 管理后台  │    │  后端API │    │ MySQL │    │通知服务│
└───┬────┘    └────┬─────┘    └────┬─────┘    └───┬───┘    └───┬────┘
    │              │               │              │            │
    │ 1.查看待审核  │               │              │            │
    │─────────────▶│               │              │            │
    │              │               │              │            │
    │              │ 2.GET /admin/houses/pending   │            │
    │              │──────────────▶│              │            │
    │              │               │              │            │
    │              │               │ 3.查询pending房源          │
    │              │               │─────────────▶│            │
    │              │               │              │            │
    │              │ 4.返回房源列表 │              │            │
    │              │◀──────────────│              │            │
    │              │               │              │            │
    │ 5.显示列表   │               │              │            │
    │◀─────────────│               │              │            │
    │              │               │              │            │
    │ 6.审核通过   │               │              │            │
    │─────────────▶│               │              │            │
    │              │               │              │            │
    │              │ 7.POST /admin/houses/{id}/audit            │
    │              │──────────────▶│              │            │
    │              │               │              │            │
    │              │               │ 8.更新状态approved         │
    │              │               │─────────────▶│            │
    │              │               │              │            │
    │              │               │ 9.发送通知   │            │
    │              │               │──────────────────────────▶│
    │              │               │              │            │
    │              │               │              │ 10.通知房东 │
    │              │               │              │◀───────────│
    │              │               │              │            │
    │              │ 11.返回成功    │              │            │
    │              │◀──────────────│              │            │
```
