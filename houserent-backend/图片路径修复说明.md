# 图片路径修复说明文档

## 修复日期
2024年12月29日（第二版更新）

## 问题描述
1. **原问题**：数据库保存完整MinIO URL（包含固定IP地址 `http://172.31.14.194:9000`），导致换电脑后失效
2. **微信小程序真机问题**：真机无法直接访问内网MinIO服务器，图片无法显示
3. **配置固定IP问题**：配置文件写死IP地址，换电脑需要手动修改
4. **路径格式错误问题**：数据库错误保存了 `api/img/avatars/xxx.jpg` 格式（应为 `avatars/xxx.jpg`）

## 解决方案

### 核心思路
1. **数据库只保存相对路径**：格式为 `bucket/objectName`，如 `avatars/xxx.jpg`（不含 `api/img/` 前缀）
2. **自动获取本地IP**：配置 `api.server.url=auto`，系统自动检测局域网IP，换电脑无需改配置
3. **返回时动态生成代理URL**：通过API服务器代理MinIO图片请求，格式为 `http://自动检测的IP:8888/api/img/avatars/xxx.jpg`
4. **后端代理接口**：已存在的 `/api/img/{bucket}/**` 接口用于代理MinIO图片请求
5. **路径格式修复**：新增 `extractRelativePath` 方法能正确处理 `api/img/` 前缀，避免重复拼接

### 微信小程序真机调试图片显示解决方案
**原因分析**：
- 微信小程序真机无法直接访问内网IP（如 192.168.x.x 或 172.x.x.x）
- MinIO默认部署在内网，真机无法访问
- 开发工具中可以访问是因为工具运行在电脑上

**解决方法**：
1. 后端提供图片代理接口（已实现：`/api/img/{bucket}/**`）
2. 所有图片URL统一返回代理URL格式
3. 真机通过API服务器代理访问MinIO图片

## 修改文件清单

### 1. 配置文件
**文件**：`src/main/resources/application.properties`
- 添加 `api.server.url` 配置项，用于生成代理URL
- 说明：开发环境使用局域网IP，生产环境使用域名

### 2. 新增配置类
**文件**：`src/main/java/org/example/rentingmanagement/config/ServerConfig.java`
- 自动检测本机局域网IP地址
- 优先使用 `192.168.x.x` 段IP
- 支持配置 `auto` 自动检测或手动指定服务器地址
- 换电脑无需修改配置文件

### 3. 新增/更新工具类
**文件**：`src/main/java/org/example/rentingmanagement/util/ImageUrlUtil.java`
- `toProxyUrl(String relativePath)`：将相对路径转换为代理URL
- `extractRelativePath(String url)`：从URL提取相对路径（修复：能正确处理 `api/img/` 前缀）
- `buildRelativePath(String bucketName, String objectName)`：构建相对路径
- 使用 `ServerConfig` 动态获取服务器地址
- 兼容旧数据：自动识别并转换旧的完整URL格式

### 4. Service层修改

#### MinioServiceImpl
**文件**：`src/main/java/org/example/rentingmanagement/service/impl/MinioServiceImpl.java`
- `uploadFile()` 方法返回相对路径而非完整URL
- `getFileUrl()` 方法返回相对路径
- `extractObjectNameFromUrl()` 方法兼容相对路径和完整URL格式

#### FileUploadServiceImpl
**文件**：`src/main/java/org/example/rentingmanagement/service/impl/FileUploadServiceImpl.java`
- 引入 `ImageUrlUtil`
- 上传文件时保存相对路径到数据库
- `getFileUrl()` 方法返回相对路径

#### HouseImageServiceImpl
**文件**：`src/main/java/org/example/rentingmanagement/service/impl/HouseImageServiceImpl.java`
- 上传房源图片时保存相对路径到数据库

#### HouseServiceImpl
**文件**：`src/main/java/org/example/rentingmanagement/service/impl/HouseServiceImpl.java`
- 引入 `ImageUrlUtil` 替代原有的 `transformMinioUrl()` 方法
- `getHouseDetail()` 方法返回时转换图片URL和房东头像URL为代理URL
- `searchHouses()` 方法返回时转换封面图URL为代理URL
- `getLandlordHouses()` 方法返回时转换封面图URL为代理URL

### 5. Controller层修改

#### FileUploadController
**文件**：`src/main/java/org/example/rentingmanagement/controller/FileUploadController.java`
- 引入 `ImageUrlUtil`
- 所有返回图片URL的接口都转换为代理URL：
  - `uploadAvatar()` - 头像上传
  - `uploadFile()` - 单文件上传
  - `uploadFiles()` - 批量上传
  - `getFileUrl()` - 获取文件URL
  - `getFilesByCategory()` - 按分类获取文件
  - `getUserFiles()` - 获取用户文件

#### UserController
**文件**：`src/main/java/org/example/rentingmanagement/controller/UserController.java`
- 引入 `ImageUrlUtil`
- `getUserProfile()` 方法返回时转换头像URL为代理URL
- `updateUserProfile()` 方法保存时转换为相对路径，返回时转换为代理URL
- `updateAvatar()` 方法保存相对路径，返回代理URL

#### HouseController
**文件**：`src/main/java/org/example/rentingmanagement/controller/HouseController.java`
- 引入 `ImageUrlUtil`
- `uploadHouseImages()` 方法返回时转换图片URL为代理URL
- `getHouseImages()` 方法返回时转换图片URL为代理URL

## 数据迁移说明

### ⚠️ 重要：必须执行数据清理
由于之前的bug，数据库中可能保存了错误格式的路径：
- ❌ 错误格式：`api/img/avatars/xxx.jpg`
- ✅ 正确格式：`avatars/xxx.jpg`

**必须在重启服务前执行数据清理SQL脚本**：`数据库路径清理脚本.sql`

### 旧数据兼容
**ImageUrlUtil** 工具类已内置旧数据兼容逻辑：
- 如果数据库中存储的是完整URL（如 `http://192.168.31.106:9000/avatars/xxx.jpg`）
- 如果数据库中存储的是错误格式（如 `api/img/avatars/xxx.jpg`）
- 工具类会自动提取相对路径（`avatars/xxx.jpg`）
- 然后转换为代理URL（`http://自动检测IP:8888/api/img/avatars/xxx.jpg`）

### 数据清理步骤
1. 备份数据库（重要！）
2. 执行 `数据库路径清理脚本.sql`
3. 检查验证查询结果，确认清理成功
4. 重启后端服务

## 配置说明

### 开发环境配置（推荐）
```properties
# MinIO配置 - 内部访问地址（后端访问MinIO使用）
minio.endpoint=http://192.168.31.106:9000

# API服务器地址 - 自动检测本机IP（推荐，换电脑无需改配置）
api.server.url=auto
```

### 开发环境手动配置（不推荐）
```properties
# MinIO配置 - 内部访问地址
minio.endpoint=http://192.168.31.106:9000

# API服务器地址 - 手动指定IP（每次换电脑都需要修改）
api.server.url=http://192.168.31.106:8888
```

### 生产环境配置
```properties
# MinIO配置 - 内部访问地址
minio.endpoint=http://minio-internal:9000

# API服务器地址 - 使用域名（生产环境必须手动指定）
api.server.url=https://api.yourdomain.com
```

### 配置说明
- **auto**：自动检测本机局域网IP，优先使用 `192.168.x.x` 段
- **手动指定**：如 `http://192.168.31.106:8888` 或 `https://api.yourdomain.com`
- **换电脑**：使用 `auto` 无需任何修改，使用手动指定需要修改IP

## 图片访问流程

### 上传流程
1. 前端/小程序上传图片到后端API
2. 后端将图片存储到MinIO
3. 后端在数据库中保存相对路径（如 `avatars/xxx.jpg`）
4. 后端返回代理URL给前端（如 `http://192.168.31.106:8888/api/img/avatars/xxx.jpg`）

### 访问流程
1. 前端/小程序使用代理URL请求图片
2. 请求到达 `/api/img/{bucket}/**` 接口
3. 后端从MinIO获取图片数据
4. 后端将图片数据返回给前端

### URL格式对比

| 类型 | 格式 | 说明 |
|------|------|------|
| 旧格式（不要使用） | `http://172.31.14.194:9000/avatars/xxx.jpg` | 固定IP，换电脑失效 |
| 相对路径（数据库存储） | `avatars/xxx.jpg` | 不包含服务器信息 |
| 代理URL（返回前端） | `http://192.168.31.106:8888/api/img/avatars/xxx.jpg` | 通过API服务器代理 |

## 测试验证

### 1. 检查服务器启动日志
```
启动后查看日志，应该看到：
自动检测到服务器地址: http://192.168.31.106:8888
```

### 2. 测试上传功能
```bash
# 上传头像
curl -X POST http://192.168.31.106:8888/api/upload/avatar \
  -H "Authorization: Bearer {token}" \
  -F "file=@test.jpg"

# 期望返回（注意URL使用的是自动检测的IP）：
# {"code": 200, "message": "头像上传成功", "data": "http://192.168.31.106:8888/api/img/avatars/xxx.jpg"}

# 检查数据库，file_url字段应该是：avatars/xxx.jpg（不含 api/img/ 前缀）
```

### 3. 测试图片访问
```bash
# 直接访问代理URL
curl http://192.168.31.106:8888/api/img/avatars/xxx.jpg

# 期望返回：图片二进制数据
```

### 4. 微信小程序真机测试
1. 确保手机和电脑连接同一局域网
2. 真机预览，验证图片能正常显示
3. 检查网络请求，确认使用的是自动检测的服务器地址
4. 图片应该能正常加载（不会出现404或重复 `api/img/` 的问题）

## 注意事项

1. **⚠️ 必须先执行数据清理SQL**：重启服务前务必执行 `数据库路径清理脚本.sql`
2. **自动IP检测**：开发环境使用 `api.server.url=auto`，换电脑无需改配置
3. **数据库路径格式**：必须是 `avatars/xxx.jpg`，不能包含 `api/img/` 前缀
4. **多环境部署**：生产环境需手动指定域名，如 `https://api.yourdomain.com`
5. **微信小程序合法域名**：需在微信公众平台配置API服务器域名为合法域名
6. **HTTPS要求**：生产环境小程序要求HTTPS，需配置SSL证书
7. **图片缓存**：代理接口已设置 `Cache-Control: max-age=86400`，客户端会缓存24小时
8. **真机调试**：确保手机和电脑在同一局域网

## 后续优化建议

1. **CDN加速**：可在代理接口前加CDN，提升图片加载速度
2. **图片压缩**：上传时自动压缩图片，减少存储和传输成本
3. **图片格式转换**：支持WebP等现代图片格式
4. **访问统计**：在代理接口中增加访问统计，分析图片使用情况
5. **防盗链**：增加Referer验证或Token验证，防止图片被盗链

## 技术支持

### 常见问题排查

**问题1：真机图片不显示**
- 检查数据库路径格式是否正确（应为 `avatars/xxx.jpg`，不含 `api/img/`）
- 检查启动日志中的服务器地址是否正确
- 确认手机和电脑在同一局域网
- 使用浏览器访问 `http://检测到的IP:8888/api/img/avatars/xxx.jpg` 测试

**问题2：自动检测IP不正确**
- 手动指定：将 `api.server.url=auto` 改为 `api.server.url=http://你的IP:8888`
- 查看日志中列出的所有网络接口和IP

**问题3：数据库路径含 api/img/ 前缀**
- 立即执行 `数据库路径清理脚本.sql`
- 重启服务

**问题4：换电脑后图片失效**
- 如果使用 `auto`：无需任何操作，自动适配
- 如果手动指定：修改 `api.server.url` 配置

### 检查清单
- [ ] 已执行数据库清理SQL脚本
- [ ] 数据库中的路径格式正确（不含 api/img/ 前缀）
- [ ] MinIO服务正常运行
- [ ] `api.server.url` 配置为 `auto` 或正确的服务器地址
- [ ] 启动日志显示正确的服务器地址
- [ ] 图片代理接口 `/api/img/{bucket}/**` 可访问
- [ ] 微信小程序合法域名已配置（生产环境）

---

**修复完成时间**：2024-12-29
**修复人员**：Cascade AI
**版本**：v2.0（修复路径格式问题，新增自动IP检测）
