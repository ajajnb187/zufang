# 微信小程序真机调试图片不显示解决方案

## 问题原因

**微信小程序真机调试的限制：**
1. 开发工具的"不校验合法域名"设置**只对开发工具有效，真机无效**
2. 真机必须使用 **HTTPS** 协议
3. 真机不能直接访问局域网IP（如 `192.168.x.x`）
4. 必须配置**合法域名**或使用**内网穿透**

## 解决方案对比

| 方案 | 支持真机 | 需要HTTPS | 需要域名 | 难度 | 推荐度 |
|------|---------|----------|---------|------|--------|
| 开发工具"不校验域名" | ❌ | ❌ | ❌ | 简单 | ⭐ |
| 内网穿透（cpolar/ngrok） | ✅ | ✅ | ❌ | 简单 | ⭐⭐⭐⭐⭐ |
| 配置正式域名+SSL证书 | ✅ | ✅ | ✅ | 复杂 | ⭐⭐⭐ |

## 推荐方案：使用内网穿透（cpolar）

### 为什么选择 cpolar？
- ✅ 国内访问速度快
- ✅ 免费版够用
- ✅ 自动提供 HTTPS
- ✅ 无需购买域名
- ✅ 5分钟搞定

### 步骤1：安装 cpolar

**Windows：**
1. 访问：https://www.cpolar.com/
2. 注册账号并登录
3. 下载 Windows 客户端
4. 安装并启动

**或使用命令行：**
```bash
# 下载
curl -L https://www.cpolar.com/static/downloads/cpolar-stable-windows-amd64.zip -o cpolar.zip

# 解压后运行
cpolar.exe authtoken <你的token>
```

### 步骤2：启动内网穿透

```bash
# 穿透本地 8888 端口
cpolar http 8888
```

**输出示例：**
```
Forwarding  https://abc123.cpolar.cn -> http://localhost:8888
```

### 步骤3：修改配置文件

修改 `application.properties`：

```properties
# 使用 cpolar 提供的 HTTPS 地址
api.server.url=https://abc123.cpolar.cn
```

**注意：** 每次重启 cpolar，域名会变化（免费版），需要重新修改配置

### 步骤4：重启后端服务

重启 Spring Boot 应用，查看日志：
```
✅ 使用配置的服务器地址: https://abc123.cpolar.cn
```

### 步骤5：测试

1. 浏览器访问：`https://abc123.cpolar.cn/api/user/profile`
2. 小程序真机调试，图片应该能正常显示

## 方案2：使用 ngrok（国外工具）

### 安装 ngrok

1. 访问：https://ngrok.com/
2. 注册账号
3. 下载客户端

### 启动穿透

```bash
ngrok http 8888
```

**输出示例：**
```
Forwarding  https://xyz789.ngrok.io -> http://localhost:8888
```

### 修改配置

```properties
api.server.url=https://xyz789.ngrok.io
```

## 方案3：购买域名+SSL证书（生产环境）

### 步骤概览

1. **购买域名**（如 `yourdomain.com`）
2. **申请SSL证书**（免费：Let's Encrypt / 阿里云免费证书）
3. **配置Nginx反向代理**
4. **配置微信小程序合法域名**

### Nginx 配置示例

```nginx
server {
    listen 443 ssl;
    server_name api.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:8888;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 微信小程序后台配置

1. 登录：https://mp.weixin.qq.com/
2. 开发管理 → 开发设置 → 服务器域名
3. 添加：`https://api.yourdomain.com`

## 常见问题

### Q1：cpolar 免费版域名会变化怎么办？

**方案A：** 升级付费版（固定域名）
**方案B：** 每次启动后修改配置文件
**方案C：** 使用环境变量：
```bash
# 启动时指定
java -jar app.jar --api.server.url=https://新域名.cpolar.cn
```

### Q2：内网穿透速度慢怎么办？

- cpolar 国内节点速度较快
- ngrok 可能较慢（国外服务器）
- 考虑使用付费版或自建 frp

### Q3：生产环境怎么办？

**必须使用方案3**（正式域名+SSL），内网穿透仅用于开发调试。

### Q4：图片还是不显示？

检查清单：
- [ ] cpolar/ngrok 是否正常运行
- [ ] 配置文件中的 URL 是否正确（HTTPS）
- [ ] 后端服务是否已重启
- [ ] 浏览器能否访问 `https://域名/api/img/avatars/xxx.jpg`
- [ ] 小程序是否重新编译

## 推荐配置（开发环境）

### 使用 cpolar + 自动配置

**application.properties：**
```properties
# 开发环境：使用 cpolar
api.server.url=${CPOLAR_URL:auto}
```

**启动脚本：**
```bash
# 1. 启动 cpolar
cpolar http 8888

# 2. 获取 URL（从 cpolar 控制台复制）
export CPOLAR_URL=https://abc123.cpolar.cn

# 3. 启动应用
java -jar app.jar
```

## 总结

| 场景 | 推荐方案 |
|------|---------|
| 本地开发（仅开发工具） | 不校验域名 + auto |
| 真机调试 | cpolar 内网穿透 |
| 生产环境 | 正式域名 + SSL |

---

**最快解决方法：**
1. 下载安装 cpolar（5分钟）
2. 运行 `cpolar http 8888`
3. 复制 HTTPS 地址到 `api.server.url`
4. 重启后端
5. 真机测试 ✅

**官网：**
- cpolar: https://www.cpolar.com/
- ngrok: https://ngrok.com/
