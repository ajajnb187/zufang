# 小程序端图片不显示排查步骤

## 问题现象
- 后端日志显示URL转换正确：`http://192.168.137.1:8888/api/img/avatars/xxx.png`
- 但后端没有收到图片代理请求（没有"=== 代理图片请求 ==="日志）
- 说明：**真机没有请求图片，问题在小程序端**

## 排查步骤

### 步骤1：检查小程序接收的数据

在获取用户信息的地方添加日志：

```javascript
// pages/profile/profile.js 或类似文件
getUserInfo() {
  wx.request({
    url: 'http://192.168.137.1:8888/api/user/profile',
    header: {
      'Authorization': 'Bearer ' + wx.getStorageSync('token')
    },
    success: (res) => {
      console.log('===== 调试信息 =====');
      console.log('完整响应:', res);
      console.log('用户数据:', res.data.data);
      console.log('头像URL:', res.data.data.avatarUrl);
      console.log('URL类型:', typeof res.data.data.avatarUrl);
      console.log('==================');
      
      this.setData({
        userInfo: res.data.data
      });
    }
  });
}
```

**期望输出：**
```
头像URL: http://192.168.137.1:8888/api/img/avatars/2c7efec34e0a4b8c98104d22dcb910dd.png
```

### 步骤2：检查 WXML 模板

```xml
<!-- 确保使用正确的字段 -->
<image src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>

<!-- 临时添加调试信息 -->
<view style="font-size: 12px; color: red;">
  头像URL: {{userInfo.avatarUrl}}
</view>
```

### 步骤3：检查是否有URL处理逻辑

搜索小程序代码中是否有这些：

```javascript
// ❌ 错误示例1：写死了旧IP
const API_BASE = 'http://192.168.31.106:8888';
avatarUrl = API_BASE + '/api/img/' + relativePath;

// ❌ 错误示例2：自己拼接路径
avatarUrl = `${config.baseUrl}/api/img/${path}`;

// ❌ 错误示例3：替换了域名
avatarUrl = url.replace('http://192.168.137.1:8888', 'http://localhost:8888');

// ✅ 正确做法：直接使用后端返回的URL
avatarUrl = res.data.data.avatarUrl;
```

### 步骤4：检查网络请求

真机调试时，打开调试面板（vConsole）：

1. 点击右下角的绿色圆点
2. 切换到 Network 标签
3. 查看是否有图片请求
4. 如果有，查看请求的URL和状态码
5. 如果没有，说明小程序根本没发起请求

### 步骤5：常见问题修复

#### 问题A：小程序配置了固定域名

**检查：** `app.js` 或 `config.js`

```javascript
// ❌ 错误
const config = {
  apiBase: 'http://192.168.31.106:8888',  // 写死了旧IP
  imgBase: 'http://192.168.31.106:8888/api/img'
};

// ✅ 修复：删除 imgBase，直接使用后端返回的完整URL
const config = {
  apiBase: 'http://192.168.137.1:8888'  // 只配置API基础地址
};
```

#### 问题B：使用了相对路径拼接

**检查：** 显示头像的组件或页面

```javascript
// ❌ 错误
data: {
  avatarPath: 'avatars/xxx.png'  // 只存了相对路径
},
computed: {
  avatarUrl() {
    return `${app.globalData.imgBase}/${this.data.avatarPath}`;
  }
}

// ✅ 修复：直接存完整URL
data: {
  avatarUrl: 'http://192.168.137.1:8888/api/img/avatars/xxx.png'
}
```

#### 问题C：图片缓存

```javascript
// 清除缓存
wx.clearStorage();

// 或者给图片URL加时间戳
<image src="{{avatarUrl}}?t={{timestamp}}"></image>
```

#### 问题D：image 组件的 src 属性问题

```xml
<!-- ❌ 错误：使用了错误的字段 -->
<image src="{{userInfo.avatar}}"></image>

<!-- ✅ 正确：使用 avatarUrl -->
<image src="{{userInfo.avatarUrl}}"></image>

<!-- 或者检查是否需要解析 -->
<image src="{{userInfo.avatarUrl || defaultAvatar}}"></image>
```

## 快速验证方法

### 方法1：硬编码测试

临时在小程序中硬编码URL：

```javascript
this.setData({
  testUrl: 'http://192.168.137.1:8888/api/img/avatars/2c7efec34e0a4b8c98104d22dcb910dd.png'
});
```

```xml
<image src="{{testUrl}}" mode="aspectFill"></image>
```

**如果硬编码能显示：** 说明是数据传递问题
**如果硬编码也不显示：** 说明是网络或权限问题

### 方法2：浏览器测试

在手机浏览器中直接访问：
```
http://192.168.137.1:8888/api/img/avatars/2c7efec34e0a4b8c98104d22dcb910dd.png
```

**如果浏览器能显示：** 说明是小程序的问题
**如果浏览器不能显示：** 说明是网络连接问题

## 最可能的原因

根据经验，90%的情况是：

1. **小程序端写死了旧的IP地址**
2. **小程序端自己拼接了URL，没有使用后端返回的完整URL**
3. **小程序端对URL做了错误的处理（如替换、截取等）**

## 解决方案

**找到小程序中所有处理图片URL的地方，改为直接使用后端返回的完整URL。**

```javascript
// 获取用户信息
getUserInfo() {
  wx.request({
    url: `${this.globalData.apiBase}/api/user/profile`,
    success: (res) => {
      // ✅ 直接使用后端返回的 avatarUrl，不要做任何处理
      this.setData({
        avatarUrl: res.data.data.avatarUrl  // 完整URL
      });
    }
  });
}
```

## 需要提供的信息

请提供以下信息以便进一步诊断：

1. 小程序控制台输出的 `avatarUrl` 值
2. 小程序 Network 面板的截图（是否有图片请求）
3. 小程序中处理头像URL的代码片段
4. 手机浏览器能否访问 `http://192.168.137.1:8888/api/img/avatars/xxx.png`
