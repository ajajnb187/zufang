# 真机图片不显示问题修复报告

## 🎯 问题描述

**现象：**
- ✅ 微信小程序模拟器中图片显示正常
- ❌ 真机调试时图片不显示
- ✅ 电脑浏览器可以访问图片URL：`http://192.168.137.1:8888/api/img/avatars/xxx.jpg`
- ✅ 真机可以访问其他所有后端API接口

## 🔍 问题排查过程

### 1. 后端检查

**检查结果：✅ 后端完全正常**

从日志确认：
```
2025-12-29 19:26:46 [http-nio-8888-exec-6] INFO  o.e.r.util.ImageUrlUtil - toProxyUrl - ServerUrl: http://192.168.137.1:8888, 输入: avatars/9a62b32194a749d1b1b73cf037d76c9f.jpg, 输出: http://192.168.137.1:8888/api/img/avatars/9a62b32194a749d1b1b73cf037d76c9f.jpg
```

- ✅ 图片上传成功
- ✅ 数据库保存正确路径：`avatars/xxx.jpg`
- ✅ 返回正确代理URL：`http://192.168.137.1:8888/api/img/avatars/xxx.jpg`
- ❌ **后端没有收到图片请求**（日志中没有"=== 代理图片请求 ==="）

**结论：真机根本没有请求图片，问题在小程序端**

### 2. 小程序端检查

**检查文件：** `houserent-uniapp/utils/config.js`

**发现问题：**

```javascript
// 第11行 - 旧配置（错误）
const DEV_IP = '192.168.31.106' // ❌ 旧IP地址

// 第27行 - WebSocket配置（错误）
const DEV_IP = '172.31.14.194' // ❌ 错误的IP地址
```

**问题分析：**
- 小程序真机使用的是 `192.168.31.106`
- 后端实际运行在 `192.168.137.1`
- 导致真机请求发到了错误的地址
- 模拟器使用 `localhost`，所以正常

## ✅ 解决方案

### 修复内容

**文件：** `d:\桌面\design\houserent-uniapp\utils\config.js`

#### 修改1：API地址配置
```javascript
// 修改前
const DEV_IP = '192.168.31.106' // ❌

// 修改后
const DEV_IP = '192.168.137.1' // ✅
```

#### 修改2：WebSocket地址配置
```javascript
// 修改前
const DEV_IP = '172.31.14.194' // ❌

// 修改后
const DEV_IP = '192.168.137.1' // ✅
```

### 工作原理

**小程序配置逻辑：**
```javascript
const getBaseURL = () => {
    const systemInfo = uni.getSystemInfoSync()
    const DEV_IP = '192.168.137.1'
    
    // 真机环境
    if (systemInfo.platform !== 'devtools') {
        return `http://${DEV_IP}:8888/api`
    }
    
    // 模拟器环境
    return 'http://localhost:8888/api'
}
```

**为什么模拟器可以，真机不行？**
- 模拟器运行在电脑上，使用 `localhost` 直接访问本地后端
- 真机是独立设备，必须通过局域网IP访问电脑上的后端
- 如果IP配置错误，真机无法连接到后端

## 📋 验证步骤

### 1. 重新编译小程序

在微信开发者工具中：
1. 点击"编译" 按钮
2. 或使用快捷键 `Ctrl + B`

### 2. 真机测试

1. 点击"真机调试"
2. 扫码连接手机
3. 上传头像或查看用户信息
4. 检查图片是否显示

### 3. 查看后端日志

**期望看到：**
```
=== 代理图片请求 ===
完整URI: /api/img/avatars/xxx.jpg
Bucket: avatars
ObjectName: xxx.jpg
==================
返回图片: ContentType=image/jpeg
图片代理成功: 大小=34KB
```

### 4. 检查小程序网络请求

真机调试 → vConsole → Network 标签

**应该看到：**
- `GET http://192.168.137.1:8888/api/img/avatars/xxx.jpg` - 状态码 200

## 🎓 知识点总结

### 为什么会出现这个问题？

1. **IP地址变化**
   - 电脑的局域网IP会变化（DHCP动态分配）
   - 连接不同WiFi时IP会不同
   - 使用手机热点时IP也会不同

2. **配置未同步**
   - 后端使用了新IP（`192.168.137.1`）
   - 小程序配置还是旧IP（`192.168.31.106`）
   - 导致真机无法连接

### 如何避免这个问题？

#### 方案1：每次检查IP地址

```bash
# Windows
ipconfig

# 查找 "无线局域网适配器 WLAN" 或 "以太网适配器"
# IPv4 地址就是需要的IP
```

#### 方案2：使用固定IP

在路由器中为电脑设置静态IP绑定（MAC地址绑定）

#### 方案3：使用内网穿透（推荐开发环境）

使用 cpolar 或 ngrok，获得固定的公网域名：
```javascript
const DEV_IP = 'abc123.cpolar.cn' // 固定域名
```

### 调试技巧

#### 1. 添加IP显示

在小程序中显示当前使用的IP：
```javascript
onLoad() {
    console.log('当前API地址:', api.baseUrl)
    // 输出：http://192.168.137.1:8888/api
}
```

#### 2. 添加网络请求日志

```javascript
// app.js
const originalRequest = wx.request
wx.request = function(options) {
    console.log('请求URL:', options.url)
    return originalRequest.call(this, options)
}
```

#### 3. 检查真机网络

确保手机和电脑在同一WiFi下：
```javascript
// 在小程序中测试连接
wx.request({
    url: 'http://192.168.137.1:8888/api/user/profile',
    success: () => console.log('连接成功'),
    fail: () => console.log('连接失败')
})
```

## 📝 相关文件

### 后端文件
- `houserent-backend/src/main/java/org/example/rentingmanagement/config/ServerConfig.java` - 自动获取服务器IP
- `houserent-backend/src/main/java/org/example/rentingmanagement/controller/FileUploadController.java` - 图片代理接口
- `houserent-backend/src/main/java/org/example/rentingmanagement/util/ImageUrlUtil.java` - URL转换工具

### 小程序文件
- `houserent-uniapp/utils/config.js` - **已修复** - API地址配置
- `houserent-uniapp/pages/profile/profile.vue` - 用户信息页面

## ⚠️ 注意事项

### 1. IP地址变化时需要修改

当以下情况发生时，需要更新 `config.js` 中的IP：
- 电脑重启后IP变化
- 连接到不同的WiFi
- 使用手机热点

### 2. 生产环境配置

正式上线时，需要：
1. 购买域名
2. 配置SSL证书（HTTPS）
3. 在微信小程序后台配置合法域名
4. 修改 `config.js` 使用正式域名

```javascript
const getBaseURL = () => {
    // 生产环境
    if (process.env.NODE_ENV === 'production') {
        return 'https://api.yourdomain.com/api'
    }
    // 开发环境
    return 'http://192.168.137.1:8888/api'
}
```

### 3. 模拟器和真机的区别

| 特性 | 模拟器 | 真机 |
|------|--------|------|
| 网络环境 | 使用电脑网络 | 使用手机网络 |
| localhost | ✅ 可访问 | ❌ 不可访问 |
| 局域网IP | ✅ 可访问 | ✅ 可访问（需同一WiFi） |
| 域名校验 | ❌ 不校验 | ✅ 严格校验 |
| 性能 | 接近真实 | 真实性能 |

## 🎉 修复完成

**修改文件：**
- ✅ `houserent-uniapp/utils/config.js` - 已更新IP地址

**测试步骤：**
1. 重新编译小程序
2. 真机调试
3. 上传头像或查看用户信息
4. 检查图片是否显示
5. 查看后端日志确认收到图片请求

**预期结果：**
- ✅ 真机图片正常显示
- ✅ 后端日志显示"=== 代理图片请求 ==="
- ✅ 小程序Network面板显示图片请求成功

---

**问题根源：** 小程序配置的IP地址与后端实际IP不一致  
**解决方案：** 更新 `config.js` 中的 `DEV_IP` 为 `192.168.137.1`  
**修复时间：** 2025-12-29  
**修复状态：** ✅ 已完成
